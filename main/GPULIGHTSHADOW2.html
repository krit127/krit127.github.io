<!DOCTYPE html>
<html>
<head>
    <title>PBR Shader with UI</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            color: #fff;
        }

        #ui-container {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ui-section {
            border: 1px solid #444;
            padding: 10px;
            border-radius: 5px;
        }

        .ui-section h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .ui-button {
            background-color: #555;
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 2px;
            cursor: pointer;
            border-radius: 3px;
        }

        .ui-button:hover {
            background-color: #777;
        }

        input[type="range"] {
            width: 150px;
        }
    </style>
</head>
<body>
    <div id="ui-container">
        <div class="ui-section">
            <h3>ควบคุมแสง</h3>
            <label>ความสว่าง:</label>
            <input type="range" id="light-intensity" min="0" max="5" step="0.1" value="2">
            <br>
            <label>สีแสง:</label>
            <input type="color" id="light-color" value="#ffffff">
        </div>
        <div class="ui-section">
            <h3>เงา</h3>
            <button id="toggle-shadows" class="ui-button">เปิด/ปิดเงา</button>
        </div>
        <div class="ui-section">
            <h3>ควบคุมหุ่นยนต์</h3>
            <p>ใช้ปุ่ม WASD</p>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/EXRLoader.js"></script>
    <script>
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        const scene = new THREE.Scene();

 const exrLoader = new THREE.EXRLoader();
exrLoader.load(
    "https://krit127.github.io/textures/qwantani_noon_puresky_1k.exr",
    function(texture){
        texture.mapping = THREE.EquirectangularReflectionMapping;
        scene.background = texture;
        scene.environment = texture;
        console.log("✅ EXR HDR โหลดเสร็จ");
    },
    undefined,
    function(err){
        console.error("❌ โหลด EXR ไม่ได้", err);
    }
);

    

        // กล้อง
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 15, 25);
        const controls = new THREE.OrbitControls(camera, renderer.domElement);

        // แสง
        const ambientLight = new THREE.AmbientLight(0x555555);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 2);
        directionalLight.position.set(10, 20, 10); // ยกไฟให้สูงขึ้นเพื่อเงาจะตกลงพื้นกว้างขึ้น
        directionalLight.castShadow = true;

        // ปรับคุณภาพเงาให้คมขึ้น
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;

        // ขยายขอบเขตการฉายเงา (สำคัญมาก)
        directionalLight.shadow.camera.near = 0.5;
        directionalLight.shadow.camera.far = 200; // ให้ไกลพอ
        directionalLight.shadow.camera.left = -100;
        directionalLight.shadow.camera.right = 100;
        directionalLight.shadow.camera.top = 100;
        directionalLight.shadow.camera.bottom = -100;

        // เปิด bias ปรับให้เงาไม่ซ้อน
        directionalLight.shadow.bias = -0.0005;

        scene.add(directionalLight);

        // พื้น
        const texture = new THREE.TextureLoader().load(
            "https://krit127.github.io/textures/brick_crosswalk_diff_1k.jpg",
            () => console.log("✅ Texture โหลดเสร็จ"),
            undefined,
            err => console.error("❌ โหลด texture ไม่ได้", err)
        );
        texture.wrapS = THREE.RepeatWrapping;
        texture.wrapT = THREE.RepeatWrapping;
        texture.repeat.set(5, 5);

        const floorMaterial = new THREE.MeshStandardMaterial({ map: texture });
        const floorGeom = new THREE.PlaneGeometry(100, 100);
        const floorMesh = new THREE.Mesh(floorGeom, floorMaterial);
        floorMesh.rotation.x = -Math.PI / 2;
        floorMesh.receiveShadow = true;
        scene.add(floorMesh);

        // โหลดโมเดล
        const loader = new THREE.GLTFLoader();
let aircraft, building;

function loadModel(url, position, scale = 1, isAircraft = false) {
    loader.load(url, gltf => {
        const obj = gltf.scene;
        obj.traverse(child => {
            if (child.isMesh) {
                child.castShadow = true;
                child.receiveShadow = true;
            }
        });
        obj.position.copy(position);
        obj.scale.set(scale, scale, scale);
        scene.add(obj);

        if(isAircraft) aircraft = obj;
        else building = obj;

        console.log(`✅ โหลดโมเดล: ${url}`);
    }, undefined, err => console.error("❌ โหลดโมเดลไม่ได้", err));
}

        // Call the loadModel function with the new scale parameter
        loadModel("https://krit127.github.io/CG/model/supermarine_spitfire.glb", new THREE.Vector3(0,0,0), 1, true); // เครื่องบินควบคุม
        loadModel("https://krit127.github.io/CG/model/small_warehouse.glb", new THREE.Vector3(5,0,-5), 1.2);        // อาคารสถิติ


        // UI controls
document.getElementById('light-intensity').addEventListener('input', e=>{
    directionalLight.intensity = parseFloat(e.target.value);
});
document.getElementById('light-color').addEventListener('input', e=>{
    directionalLight.color.set(e.target.value);
});
document.getElementById('toggle-shadows').addEventListener('click', ()=>{
    renderer.shadowMap.enabled = !renderer.shadowMap.enabled;
    scene.traverse(c=>{
        if(c.isMesh){
            c.castShadow = renderer.shadowMap.enabled;
            c.receiveShadow = renderer.shadowMap.enabled;
        }
    });
});

// Keyboard movement (WASD)
const keys = {};
window.addEventListener('keydown', e=> keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e=> keys[e.key.toLowerCase()] = false);

function moveAircraft(){
    if(!aircraft) return;
    const speed = 0.2;
    if(keys['w']) aircraft.position.z -= speed;
    if(keys['s']) aircraft.position.z += speed;
    if(keys['a']) aircraft.position.x -= speed;
    if(keys['d']) aircraft.position.x += speed;
}

// Render loop
function animate(){
    requestAnimationFrame(animate);
    moveAircraft();
    controls.update();
    renderer.render(scene, camera);
}
animate();

// Resize
window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>